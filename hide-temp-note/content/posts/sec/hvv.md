---
title: "蓝队进阶攻略"
date: 2024-05-18
description: "各种场景的应急，安全设备的使用，网络安全知识储备，java 反序列化的原理和特征，防御红队的攻击和钓鱼"
tags: ["蓝队理论"]
featured_image: ""
# images is optional, but needed for showing Twitter Card
images: []
categories: "sec"
comment: false
draft: false
---

# 应急类问题

---

### 应急问题的回答公式

先隔离出现问题的主机；判断影响范围；找到漏洞源头；清除攻击载荷；安全加固，修复漏洞；溯源分析；输出报告。

根据具体情况选择性填充细节。

---

### 你到客户现场进行安全加固都要做哪些事

检查弱口令和未授权访问；确定开启了日志的审计功能；检查防火墙策略，关闭不必要的端口；停止不必要的服务，修改不必要的权限；检查系统补丁；更新中间件版本。

---

### ddos 的加固和处置

加固：部署负载均衡、多节点、cdn、集群；部署抗 ddos 设备、流量监控设备；关闭非必要端口。

处置：判断 ddos 的类型（网络层、传输层、应用层）；封禁异常访问的 ip；保留攻击期间的 ip 进行取证；调整安全设备的防护策略；联系运营商清洗流量。

---

### 发现网页篡改，你会怎么做

隔离被感染主机。

排查业务系统，判断影响范围。

确定漏洞源头。

修复漏洞，加固系统。

查找数据备份，恢复业务。

查询日志和设备告警记录进行溯源反制，建立攻击者画像。

输出报告。

---

### 已知 webshell 上传，你应该怎么做

首先对失陷的主机进行隔离，看情况可以断网。

然后确定 webshell 的位置和创建时间，可以用 D 盾、河马等工具，也可以自己查看日志文件。

清除 webshell 之后排查是否留有后门。

通过日志查看是否进行了危险操作。查看是否有新增用户。查看可疑的进程、服务、网络连接。

排查后门之后报告漏洞点，提供加固修复的建议。

通过日志进行溯源，建立攻击者画像。

整理工作，输出一份报告。

---

### 攻击者在外网，但是设备出现内网告警，怎么解释这种现象，怎么看到真实 ip

可能是安全设备误报，在安全设备采集数据的时候把一些 ip 转换成了内网 ip 导致告警显示的是内网，出现这种误报可能是安全设备在网络拓扑中的位置错了；可能是 ip 欺骗，例如 xff 请求头伪造；可能有 ssrf 漏洞可以访问内网；可能有失陷主机正在进行横向移动。

需要根据告警内容排查是否为误报。

可以通过 x-forwarded-for 看真实 ip，其中 xff 的几项分别为：真实 ip，代理 ip-1，代理 ip-2，...

---

### 已知内网告警为真实威胁，你会怎么做

先判断是否为蜜罐。

根据告警信息定位出现问题的设备，路由器 arp 缓存表可以找内网 ip 对应的 mac 地址。

对告警的主机进行隔离，对影响范围内的主机进行排查。

清除攻击载荷。

根据日志进行分析和溯源，调查攻击方法，建立攻击者画像。

协助恢复业务，输出报告。

---

### 已知 DNS 告警，一定是感染吗，可能的原因是什么

可能是感染，也可能是历史情报相似的可疑访问。

---

### 发现已经中了勒索病毒，怎么办

隔离感染的主机，判断影响范围。

判断勒索病毒的种类，可以在病毒库中进行搜索，查找解密工具。

找到漏洞源头，进行修复和系统加固。

查看日志和设备告警记录进行溯源，建立攻击者画像。

协助恢复数据和业务，输出报告。

---

### 发现已经中了挖矿木马，怎么办

隔离被感染的主机，判断影响范围。

找到挖矿进程并终止。如果隐藏了进程可以使用一些工具进行排查，例如 linux 的 unhide。

清除可疑的定时任务和非必要服务。

根据系统日志文件排查后门，清除木马和后门。

找到漏洞源头，进行修复和加固。

协助恢复业务，输出报告。

---

### 已知内网横向移动，怎么办

隔离失陷主机，判断横向移动的影响范围。

---

### 怎么判断设备告警是不是误报

看 ip 是否来自内网，是否为正常业务。记录正常业务的特征，方便后续判断，避免封禁正常业务 ip 误伤友军。

看流量特征是否为恶意，根据具体的 payload 判断是否攻击成功。例如攻击者扫描返回 400，或者使用的 poc 是我们没有用到的组件，那么这些告警没有产生危害，封 ip 进行预防即可。

---

# 设备类问题

---

### 天眼每个字段的含义

sip 源 ip，dip 为目的 ip，sport 为源端口，dport 为目的端口。

attack sip 表示攻击者的 ip。

dns type 字段，0 表示 dns 请求，1 表示 dns 响应，addr 表示该 host 对应的 ip 地址，可能有多个记录。

proto 字段表示协议。

from 字段表示发件人。

GEO 字段表示 ip 的物理位置。

---

### 天眼告警的结果除了成功还有哪些，怎么判断

成功，失败，尝试，未知。未知一般是告警误报。

---

### 天眼内网横向的告警类型

基于 cs 的告警，隧道类的告警，内网段进行漏洞扫描的告警，源于内网的暴力破解的告警。

---

### 怎么通过天眼判断资产是否失陷

不断外联恶意地址，有 webshell 连接的告警或者隧道类的告警，就可以判断为资产已经失陷。

---

### 发现天眼中受害 ip 为源 ip，怎么解释

可能是安全设备配置错误导致的误报；可能是 ip 欺骗，xff 请求头伪造；也可能是 ssrf 或者内网横向。

---

### 天眼分析平台中 IOC 表示什么含义，反映了什么

IOC 表示匹配成功的威胁情报。

IOC 反映了主机的失陷特征信息，包括：入侵工具、恶意软件和攻击者画像。

---

### 天眼分析平台的运算符有哪些

AND，OR，NOT。

---

### 给定一个天眼日志，要求搜索 80 和 443 端口的记录，怎么做

语法 sport eq 80 OR sport eq 443 OR dport eq 80 OR dport eq 443。

---

### 给定一个天眼日志，要求搜索源 ip 为 A 并且目的 ip 为 B 的日志，怎么做

语法 sip(A) AND dip(B)，其中 AND 要大写。

---

### 天眼模糊搜索怎么写查询语句

搜索关键词，用 * 号加部分名称进行模糊搜索。

---

### 天眼告警主机外联流量，怎么排查

要判断外联的地址是否为恶意网址或者 dnslog 平台。

通过威胁情报平台判断外链地址是否是恶意或者是 dnslog 平台。

如果判断为恶意或 dnslog 并且连接次数较多，可判断主机异常。

---

### 天眼告警显示成功利用，怎么处理

根据告警类型分析回显，初步判断是否为误报。如果数据包无法判断，则尝试复现攻击。

在确认成功利用之后，立刻通报研判组和客户，进行应急。

如果确认是误报，则使用分析平台查看攻击 ip 的其他攻击行为和攻击结果，将发现时间和攻击行为反馈给客户。

---

### 用过 edr 设备吗

edr 就是终端安全响应，在之前实习的单位用过深信服的 edr，主要是做基线安全加固。深信服 edr 打补丁不需要重启服务，印象比较深刻。

深信服 edr 的基线合规检查项举例：密码策略、账户检测、安全审计策略、登录检测、防火墙、自动更新、非必要服务、防暴力破解、永恒之蓝检测、防恶意代码。

---

### 常用的 wireshark 过滤语法有哪些

搜索 ip 为 127.0.0.1 的流量可以用 ip.src eq 127.0.0.1 or ip.dst eq 127.0.0.1 或者 ip.addr eq 127.0.0.1。

搜索端口为 80 的流量可以用 tcp.port eq 80 or udp.port eq 80。

搜索 tcp 协议并忽略 udp 协议可以用 tcp and !udp。

搜索 uri 中含有 .mp3 的请求可以用 http.request.uri contains “.mp3”

搜索 post 请求可以用 http.request.method == “POST”。

---

# 常识类问题

---

### redis 未授权访问在什么条件下能做到 rce

redis 未授权访问的条件：（1）redis 默认的 6379 端口可以在公网访问；（2）redis 密码使用弱口令。

后续 rce 利用及其条件：方法 1，写 ssh，需要服务器有 .ssh 目录并且 redis 有写入权限。方法 2，写 webshell，需要知道 web 的绝对路径。方法 3，主从复制，需要 redis 版本大于等于 4.x，无其他条件。

---

### ssrf 用 redis 提升为 rce

场景：redis 端口无法在公网访问，用 ssrf 进内网 getshell。

用 dict 协议探测，用 gopher 协议写入。直接写 webshell 还是需要知道 web 的绝对路径，例如 /var/www/html。

---

# java 类问题

---

### fastjson 不出网怎么利用

---

### log4j2 和 fastjson 联动